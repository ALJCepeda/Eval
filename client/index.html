<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Editor</title>

  <script src="/lib/knockout.js"></script>
  
  <style type="text/css" media="screen">
    body {
        overflow: hidden;
    }
    #editor {
        margin: 0;
        position: absolute;
        top: 50px;
        bottom: 0;
        left: 0;
        right: 0;
    }
  </style>
</head>
<body>

<div style="width:100%; height:50px;">
	<p>
		Platform: 
		
		<select data-bind="	options: languages,
                       		value: selectedLanguage,
                       		optionsCaption: 'Choose...'"></select>

        Version:

        <select data-bind=" options:versions,
        					value: selectedVersion,
        					optionsCaption: 'Choose...'"></select>

       	Theme:

       	<select data-bind=" options:themes,
       						value:selectedTheme,
       						optionsCaption: 'Choose...'"></select>

        <button id="submit" style="float:right;" data-bind="click:submit">Submit</button>
   </p>
</div>

<pre id="editor"></pre>

<script src="assets/ace-builds/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
	var Model = function(aceEditor) {
		var self = this;
		this.supported = ko.observable({});
		this.themes = ko.observableArray([]);

		this.selectedLanguage = ko.observable();
		this.selectedVersion = ko.observable();
		this.selectedTheme = ko.observable('twilight');

		this.doc = aceEditor.session.getDocument();
		this.modeMap = {
			'nodejs':'javascript'
		}

		this.languages = ko.computed(function() {
			return Object.keys(self.supported());
		});

		this.versions = ko.computed(function() {
			if(self.languages().length === 0 || !self.selectedLanguage()) { return []; }
			return self.supported()[this.selectedLanguage()];
		});

		//Updates the ace editor when selected language is changed
		this.selectedLanguage.subscribe(function(value) {
			var path = typeof self.modeMap[value] !== 'undefined' ? self.modeMap[value] : value;
			editor.session.setMode("ace/mode/"+path);
		});

		this.selectedTheme.subscribe(function(value) {
			if(typeof value !== 'undefined') {
				aceEditor.setTheme("ace/theme/"+value);
			}
		})
		this.submit = function(e) {
			var postCompile = new XMLHttpRequest();
			postCompile.open("POST", "/compile");
			postCompile.setRequestHeader('Content-type', 'application/json');
			postCompile.onreadystatechange = function() {
				if(postCompile.readyState == XMLHttpRequest.DONE) {
					if(postCompile.status == 200) {
						console.log("POST script: Success");
						alert(postCompile.responseText);
					} else {
						console.log("POST script: Failure");
						console.log(postCompile.responseText);
						alert("There was an error, please try again later");
					}
				}
			}
			postCompile.send(JSON.stringify({
				type:self.selectedLanguage(),
				version:self.selectedVersion(),
				script:self.doc.getValue()
			}));
		};

		aceEditor.setTheme("ace/theme/twilight");
    	aceEditor.session.setMode("ace/mode/php");

    	var getThemes = new XMLHttpRequest();
    	getThemes.open("GET", "/themes");
    	getThemes.onreadystatechange = function() {
    		if(getThemes.readyState === XMLHttpRequest.DONE) {
    			if(getThemes.status === 200) {
    				var data = JSON.parse(getThemes.responseText);
    				console.log("GET themes: Success");
    				console.dir(data);
    				
    				self.themes(data);
    				self.selectedTheme('twilight');
    			} else {
    				console.log("GET theme: Failure");
    				console.log(getThemes.responseText);
    			}
    		}
    	}
    	getThemes.send();

		var getSupported = new XMLHttpRequest();
		getSupported.open("GET", "/supported");
		getSupported.onreadystatechange = function() {
			if(getSupported.readyState === XMLHttpRequest.DONE) {
				if(getSupported.status === 200) {
					var data = JSON.parse(getSupported.responseText);
					console.log("GET supported: Success");
					console.dir(data);

					self.supported(data);
					self.selectedLanguage('php');
					self.selectedVersion('5.6');
				} else {
					console.log("GET supported: Failure");
					console.dir(getSupported.responseText);
				}
			}
		}
		getSupported.send();
	}

	var editor = ace.edit("editor");
	ko.applyBindings(Model(editor));
</script>

</body>
</html>